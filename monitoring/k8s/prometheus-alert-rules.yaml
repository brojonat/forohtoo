apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-forohtoo-alerts
  namespace: default
  labels:
    app: prometheus
    component: server
data:
  forohtoo_alerts.yml: |
    groups:
    - name: forohtoo_workflows
      interval: 30s
      rules:

      # Alert when activities are running slower than expected
      - alert: SlowActivityExecution
        expr: |
          histogram_quantile(0.95,
            rate(poll_activity_duration_seconds_bucket[5m])
          ) > 30
        for: 5m
        labels:
          severity: warning
          component: forohtoo-worker
        annotations:
          summary: "Activity execution is slow (p95 > 30s)"
          description: "The 95th percentile of {{ $labels.activity }} execution time is {{ $value | humanizeDuration }} (over 30 seconds). This may indicate performance issues or RPC rate limiting."

      # Alert when no activities have executed (worker might be down)
      - alert: NoActivityExecutions
        expr: |
          sum(rate(poll_activity_duration_seconds_count[10m])) == 0
        for: 15m
        labels:
          severity: critical
          component: forohtoo-worker
        annotations:
          summary: "No workflow activities executing"
          description: "No workflow activities have executed in the last 15 minutes. The worker may be down or stuck."

      # Alert when activity execution rate drops significantly
      - alert: LowActivityExecutionRate
        expr: |
          sum(rate(poll_activity_duration_seconds_count[5m])) < 0.01
        for: 10m
        labels:
          severity: warning
          component: forohtoo-worker
        annotations:
          summary: "Very low activity execution rate"
          description: "Activity execution rate is {{ $value | humanize }}/sec, significantly lower than expected. Check for worker issues or RPC problems."

      # Alert on very slow activities (p99 threshold)
      - alert: VerySlowActivityExecution
        expr: |
          histogram_quantile(0.99,
            rate(poll_activity_duration_seconds_bucket[5m])
          ) > 60
        for: 10m
        labels:
          severity: critical
          component: forohtoo-worker
        annotations:
          summary: "Activity execution is extremely slow (p99 > 60s)"
          description: "The 99th percentile of {{ $labels.activity }} execution time is {{ $value | humanizeDuration }}. Severe performance degradation detected."
